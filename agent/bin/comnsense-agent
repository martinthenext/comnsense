#!/usr/bin/env python2
import argparse
import logging
import sys
import os

import zmq
from zmq.eventloop import ioloop
ioloop.install()

try:
    import comnsense_agent.utils.log
    import comnsense_agent.agent
except ImportError:
    try:
        sys.path.append(os.path.join(os.path.dirname(__file__), ".."))
    except NameError:
        sys.path.append("library")
    import comnsense_agent.utils.log
    import comnsense_agent.agent


def parse_args(args=None):
    parser = argparse.ArgumentParser()
    parser.add_argument("-s", "--server", type=str,
                        default="https://comnsense.io/api",
                        help="server connection string")
    parser.add_argument("-b", "--bind", type=str,
                        default="tcp://127.0.0.1:8888",
                        help="agent connection string")
    parser.add_argument("--log-level", type=str,
                        default="DEBUG", help="logging level")
    parser.add_argument("--log-filename", type=str,
                        help="log filename")
    return parser.parse_args(args)


def main(args):
    comnsense_agent.utils.log.setup(args.log_level, args.log_filename)
    global logger
    logger = logging.getLogger("comnsense_agent")
    agent = comnsense_agent.agent.Agent(args.bind, args.server)
    while True:
        loop = ioloop.IOLoop.instance()
        context = zmq.Context()
        try:
            agent.run(loop, context)
        except (SystemExit, KeyboardInterrupt):
            break
        except Exception, e:
            logger.exception(e)
        finally:
            context.destroy()
            context.term()
            loop.stop()
            loop.start()
            loop.close(True)
            ioloop.IOLoop.clear_instance()
            ioloop.install()


if __name__ == '__main__':
    main(parse_args())
